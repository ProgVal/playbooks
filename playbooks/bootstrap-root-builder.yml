- hosts: ceph-mon.helium
  tasks:
  - action: ceph_facts
  - name: create root image pool
    command: ceph osd pool create rbd-root-images 16 replicated replicated_hosts_hdd
    when: '"rbd-root-images" not in rbd_images'
- hosts: root-builder-bootstrap.helium
  vars:
    ceph_client_name: client.root-builder-bootstrap
    target_hostname: root-builder
  pre_tasks:
  - apt:
      name: aptitude
      state: present
  - apt:
      upgrade: yes
  roles:
  - friendship-express
  - role: ceph-rbd
    ceph_rbd_rw_pools:
    - rbd-root-images
    - rbd-common-root-images
    - rbd-system-rw
  tasks:
  - action: ceph_facts
    delegate_to: ceph-mon.helium
  - name: create middle root image
    command: rbd create -n client.root-builder-bootstrap --keyring=/etc/ceph/ceph.client.root-builder-bootstrap.keyring --size 10240 rbd-root-images/{{target_hostname}}
    when: 'target_hostname not in rbd_images["rbd-root-images"]'
  - name: create middle root image
    command: rbd create -n client.root-builder-bootstrap --keyring=/etc/ceph/ceph.client.root-builder-bootstrap.keyring --size 10240 rbd-system-rw/{{target_hostname}}
    when: 'target_hostname not in rbd_images["rbd-system-rw"]'

  - name: nbd mount block
    block:

    - name: map nbd root image
      shell: "CEPH_ARGS=\"--name {{ceph_client_name}}\" rbd-nbd map rbd-root-images/{{target_hostname}}"
      register: map_nbd
    - set_fact:
        root_nbd: '{{map_nbd.stdout}}'

    - name: map nbd default system rw image
      shell: "CEPH_ARGS=\"--name {{ceph_client_name}}\" rbd-nbd map  rbd-system-rw/{{target_hostname}}"
      register: map_nbd
    - set_fact:
        system_rw_nbd: '{{map_nbd.stdout}}'

    - name: run debootsrap
      import_tasks: utils/run_debootstrap.yml
      static: yes

    - name: create temporary keyfile
      tempfile:
          path: /run/
      register: tempfile_keyfile
    - name: write keyfile
      copy:
        content: "{{hostvars[target_hostname].disk_keyfile}}"
        dest: "{{tempfile_keyfile.path}}"
    - name: add keyfile to LUKS devices
      command: "cryptsetup luksAddKey {{item}} {{tempfile_keyfile.path}} --iter-time 1000"
      args:
          stdin: "{{hostvars[target_hostname].disk_passphrase}}"
      with_items:
      - "{{root_nbd}}p3"
      - "{{system_rw_nbd}}p2"

    - tempfile:
        state: directory
      register: tempfile_mount_root

    - name: remount block
      block:

      - name: remount root image
        command: "mount {{root_nbd}}p4 {{tempfile_mount_root.path}}"
      - name: remount boot image
        command: "mount {{root_nbd}}p2 {{tempfile_mount_root.path}}/boot"

      - name: decrypt middle etc image
        command: "cryptsetup luksOpen {{root_nbd}}p3 root_builder_crypt_etc --key-file {{tempfile_keyfile.path}}"
      - name: remount middle etc image
        command: "mount /dev/mapper/root_builder_crypt_etc {{tempfile_mount_root.path}}/mnt/__middle_etc"

      - name: decrypt system rw image
        command: "cryptsetup luksOpen {{system_rw_nbd}}p2 root_builder_crypt_system_rw --key-file {{tempfile_keyfile.path}}"
      - name: remount system rw image
        command: "mount /dev/mapper/root_builder_crypt_system_rw {{tempfile_mount_root.path}}/mnt/__system_rw"

      - name: add authorized_keys
        import_tasks: utils/ssh_authorized_keys.yml
        static: yes
        vars:
            home_path: "{{tempfile_mount_root.path}}/root"

#      - name: install packages
#        command: chroot {{tempfile_mount_root.path}} eatmydata -- apt-get install -q -y python # htop bash-completion locales debootstrap openssh-server # python3 ruby php vim emacs debian-goodies iotop iftop nethogs tcpdump lsof

      - name: disable systemd-timesyncd
        command: chroot {{tempfile_mount_root.path}} systemctl disable systemd-timesyncd
        # Disabled for two two reasons:
        # 1. it tries to write to /var/lib/systemd/clock (to ensure a monotonic clock
        #    in case the hardware does not support it)
        # 2. this is a VM, time is set by the host so it's useless

      - name: prepare mount points
        file:
            path: "{{tempfile_mount_root.path}}/mnt/{{item}}"
            state: directory
        with_items:
        - __middle_etc
        - __upper_etc
        - __system_rw/var-log/datadir
        - __system_rw/var-log/workdir

      - name: install and configure cjdns
        import_tasks: utils/cjdns.yml
        static: yes
        vars:
            chroot_dir: "{{tempfile_mount_root.path}}"

      - name: get uuids
        include_tasks: utils/lsblk.yml
        with_items:
        - {device: "{{root_nbd}}p2", var: lsblk_boot}
        - {device: "{{root_nbd}}p3", var: lsblk_middle_etc}
        - {device: "{{root_nbd}}p4", var: lsblk_root}
        - {device: "{{system_rw_nbd}}p2", var: lsblk_system_rw}

      - name: configure fstab and crypttab
        template:
            src: "{{item}}"
            dest: "{{tempfile_mount_root.path}}/etc/{{item}}"
        vars:
            boot_uuid: "{{lsblk_boot['blockdevices'][0]['uuid']}}"
            root_uuid: "{{lsblk_root['blockdevices'][0]['uuid']}}"
            middle_etc_uuid: "{{lsblk_middle_etc['blockdevices'][0]['uuid']}}"
            system_rw_uuid: "{{lsblk_system_rw['blockdevices'][0]['uuid']}}"
            etc_crypt_target: root_builder_crypt_etc
        with_items:
        - fstab
        - crypttab

      - name: configure sshd
        template:
            src: sshd_config
            dest: "{{tempfile_mount_root.path}}/etc/ssh/sshd_config"

      - name: configure replacement init
        template:
            src: overlayInit.sh
            dest: "{{tempfile_mount_root.path}}/sbin/overlayInit.sh"
            mode: "u=rwx,g=rx,o=rx"
        vars:
            etc_uuid: "{{lsblk_middle_etc['blockdevices'][0]['uuid']}}"
            etc_crypt_target: root_builder_crypt_etc
      - name: reconfigure GRUB to use the new init
        replace:
            regexp: "-amd64 root="
            replace: "-amd64 init=/sbin/overlayInit.sh root="
            path: "{{tempfile_mount_root.path}}/boot/grub/grub.cfg"

      always:
      - name: fsync
        command: sync
        changed_when: false

      - name: unmount system rw image
        command: "umount {{tempfile_mount_root.path}}/mnt/__middle_etc"
      - name: unmount system rw image
        command: "umount {{tempfile_mount_root.path}}/mnt/__system_rw"
      - name: unmount boot image
        command: "umount {{tempfile_mount_root.path}}/boot"
      - name: unmount overlay root
        command: "umount {{tempfile_mount_root.path}}"
      - name: close encrypted etc
        command: "cryptsetup luksClose root_builder_crypt_etc"
      - name: close encrypted system rw
        command: "cryptsetup luksClose root_builder_crypt_system_rw"

    always:
    - name: unmap rbd device
      command: "rbd-nbd unmap {{root_nbd}}"
    - name: unmap rbd device
      command: "rbd-nbd unmap {{system_rw_nbd}}"
